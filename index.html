<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>âœ¨ æ•¸å­—å°é­”æ‰‹ï¼šè³‡æºç­æ•¸å­¸é­”æ³•å±‹</title>
    
    <script>
      // âš ï¸ é‡è¦ï¼šç§»é™¤åŸæœ¬æ‰‹å‹•å®šç¾© window.process çš„ç¨‹å¼ç¢¼
      // ç³»çµ±æœƒè‡ªå‹•æ³¨å…¥ process.env.API_KEYï¼Œæ‰‹å‹•å®šç¾© "" æœƒå°è‡´é‡‘é‘°å¤±æ•ˆ
      
      // å…¨å±€éŒ¯èª¤æ•ç² (ç”¨æ–¼è¨ºæ–·)
      window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Global Error:', msg, lineNo);
        return false;
      };

      window.hideLoadingOverlay = function() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
          overlay.style.opacity = '0';
          setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 600);
        }
      };
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "@google/genai": "https://esm.sh/@google/genai@1.3.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
      body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; margin: 0; }
      #loading-overlay { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.6s ease; }
      .spinner { width: 60px; height: 60px; border: 6px solid #f3f4f6; border-top: 6px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      @media print { .no-print { display: none !important; } }
      .canvas-container { touch-action: none; }
      input, select { font-size: 16px !important; } /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
    </style>
  </head>
  <body>
    <div id="loading-overlay">
      <div class="spinner"></div>
      <p style="margin-top: 24px; font-weight: 900; color: #1e3a8a; font-size: 1.2rem;">ğŸª„ æ­£åœ¨ç·¨ç¹”æ•¸å­¸é­”æ³•...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Type } from "@google/genai";

      const SPECIAL_ED_INSTRUCTION = `ä½ æ˜¯ä¸€ä½è³‡æ·±çš„åœ‹å°ç‰¹æ•™è€å¸«ã€‚
1. æ’ç‰ˆï¼šå¤§å­—é«”ï¼ŒçŸ­å¥å­ã€‚
2. å…·è±¡ï¼š10 Ã· 2 = 5 éœ€åŠ è¨»ã€(å…¨éƒ¨10å€‹) åˆ†æˆ (æ¯ä»½2å€‹) æ˜¯ (5ä»½)ã€ã€‚
3. SVGï¼šä½¿ç”¨ stroke-width: 5ï¼Œç•«å‡ºé«˜å°æ¯”è‰²åœ“åœˆæˆ–éŒ¢å¹£ã€‚`;

      const DrawingCanvas = ({ id, height = 400, isVisible }) => {
        const canvasRef = useRef(null);
        const [color, setColor] = useState('#000000');
        const [isDrawing, setIsDrawing] = useState(false);
        const ctxRef = useRef(null);

        useEffect(() => {
          if (isVisible && canvasRef.current) {
            const canvas = canvasRef.current;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineWidth = 5;
            ctxRef.current = ctx;
          }
        }, [isVisible]);

        const startDrawing = (e) => {
          const rect = canvasRef.current.getBoundingClientRect();
          ctxRef.current.beginPath();
          ctxRef.current.moveTo(e.clientX - rect.left, e.clientY - rect.top);
          setIsDrawing(true);
        };

        const draw = (e) => {
          if (!isDrawing) return;
          const rect = canvasRef.current.getBoundingClientRect();
          ctxRef.current.lineTo(e.clientX - rect.left, e.clientY - rect.top);
          ctxRef.current.strokeStyle = color;
          ctxRef.current.stroke();
        };

        return (
          <div className="no-print mt-4 border-2 border-slate-200 rounded-3xl p-4 bg-slate-50">
            <div className="flex gap-2 mb-2">
              {['#000000', '#ef4444', '#3b82f6', '#22c55e'].map(c => (
                <button key={c} onClick={() => setColor(c)} className={`w-8 h-8 rounded-full border-2 ${color === c ? 'border-slate-800 scale-110' : 'border-transparent'}`} style={{backgroundColor: c}} />
              ))}
              <button onClick={() => ctxRef.current.fillRect(0,0,800,height)} className="ml-auto text-xs font-bold text-rose-500">æ¸…ç©º</button>
            </div>
            <canvas ref={canvasRef} width={800} height={height} onPointerDown={startDrawing} onPointerMove={draw} onPointerUp={() => setIsDrawing(false)} className="bg-white w-full rounded-xl cursor-crosshair touch-none" />
          </div>
        );
      };

      const App = () => {
        const [loading, setLoading] = useState(false);
        const [params, setParams] = useState({ year: '114', publisher: 'åº·è»’', grade: 'ä¸€å¹´ç´š', semester: 'ä¸Š' });
        const [chapters, setChapters] = useState([]);
        const [handout, setHandout] = useState(null);
        const [visibleCanvas, setVisibleCanvas] = useState({});

        useEffect(() => {
          window.hideLoadingOverlay();
        }, []);

        const handleQuery = async () => {
          setLoading(true);
          try {
            const apiKey = process.env.API_KEY;
            if (!apiKey) throw new Error("ç’°å¢ƒä¸­æœªåµæ¸¬åˆ° API Keyï¼Œè«‹ç¢ºèªå¹³å°è¨­å®šã€‚");
            
            const ai = new GoogleGenAI({ apiKey });
            const response = await ai.models.generateContent({
              model: 'gemini-3-flash-preview',
              contents: `åˆ—å‡º ${params.year}å­¸å¹´åº¦ ${params.publisher}ç‰ˆ åœ‹å°æ•¸å­¸ ${params.grade}${params.semester} çš„èª²ç¨‹å–®å…ƒç›®éŒ„ã€‚`,
              config: {
                tools: [{ googleSearch: {} }],
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.ARRAY,
                  items: {
                    type: Type.OBJECT,
                    properties: {
                      title: { type: Type.STRING },
                      subChapters: { type: Type.ARRAY, items: { type: Type.STRING } }
                    }
                  }
                }
              }
            });
            setChapters(JSON.parse(response.text));
          } catch (e) { 
            console.error(e);
            alert("éŒ¯èª¤ï¼š" + e.message); 
          }
          setLoading(false);
        };

        const handleGenerate = async (chap, sub) => {
          setLoading(true);
          try {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            const response = await ai.models.generateContent({
              model: 'gemini-3-pro-preview',
              contents: `è£½ä½œè³‡æºç­ã€Œ${chap} - ${sub}ã€è¬›ç¾©ã€‚å«ç™½è©±æ¦‚å¿µã€æ ¸å¿ƒSVGã€2å€‹ç·´ç¿’ã€‚`,
              config: {
                systemInstruction: SPECIAL_ED_INSTRUCTION,
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    title: { type: Type.STRING },
                    concept: { type: Type.STRING },
                    visualAidSvg: { type: Type.STRING },
                    examples: {
                      type: Type.ARRAY,
                      items: {
                        type: Type.OBJECT,
                        properties: {
                          question: { type: Type.STRING },
                          stepByStep: { type: Type.ARRAY, items: { type: Type.STRING } },
                          answer: { type: Type.STRING }
                        }
                      }
                    }
                  }
                }
              }
            });
            setHandout(JSON.parse(response.text));
          } catch (e) { alert("ç”Ÿæˆå¤±æ•—ï¼š" + e.message); }
          setLoading(false);
        };

        return (
          <div className="min-h-screen flex flex-col">
            <header className="bg-white border-b p-6 flex justify-between items-center no-print">
              <h1 className="text-2xl font-black text-slate-800">âœ¨ æ•¸å­—å°é­”æ‰‹</h1>
              <div className="text-sm font-bold text-slate-400">ç‰¹æ•™è³‡æºç­æ•¸å­¸é­”æ³•å±‹</div>
            </header>

            <div className="flex flex-1 overflow-hidden">
              <aside className="w-80 bg-white border-r p-6 overflow-y-auto no-print shadow-sm">
                <div className="space-y-6">
                  <div className="space-y-4">
                    <h2 className="font-black text-slate-700">1. è¨­å®šæ¢ä»¶</h2>
                    <select value={params.publisher} onChange={e => setParams({...params, publisher: e.target.value})} className="w-full p-3 border rounded-xl font-bold bg-slate-50">
                      <option>åº·è»’</option><option>å—ä¸€</option><option>ç¿°æ—</option>
                    </select>
                    <select value={params.grade} onChange={e => setParams({...params, grade: e.target.value})} className="w-full p-3 border rounded-xl font-bold bg-slate-50">
                      <option>ä¸€å¹´ç´š</option><option>äºŒå¹´ç´š</option><option>ä¸‰å¹´ç´š</option><option>å››å¹´ç´š</option><option>äº”å¹´ç´š</option><option>å…­å¹´ç´š</option>
                    </select>
                    <button onClick={handleQuery} className="w-full bg-blue-600 text-white p-4 rounded-xl font-black shadow-lg hover:bg-blue-700 transition active:scale-95">æŸ¥è©¢ç›®éŒ„</button>
                  </div>

                  {chapters.length > 0 && (
                    <div className="space-y-4 pt-6 border-t">
                      <h2 className="font-black text-slate-700">2. é¸æ“‡å–®å…ƒ</h2>
                      {chapters.map((c, i) => (
                        <div key={i} className="bg-blue-50/30 p-2 rounded-lg">
                          <div className="text-xs font-black text-blue-600 px-2 mb-1">{c.title}</div>
                          {c.subChapters.map((sub, si) => (
                            <button key={si} onClick={() => handleGenerate(c.title, sub)} className="w-full text-left p-2 text-sm hover:bg-white hover:shadow-sm rounded-lg font-bold text-slate-600">
                              â€¢ {sub}
                            </button>
                          ))}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </aside>

              <main className="flex-1 overflow-y-auto p-4 lg:p-10 bg-slate-50">
                {loading ? (
                  <div className="h-full flex flex-col items-center justify-center">
                    <div className="spinner mb-4"></div>
                    <p className="font-black text-slate-400">æ­£åœ¨å¬å–šæ•¸å­¸é­”æ³•...</p>
                  </div>
                ) : handout ? (
                  <article className="max-w-4xl mx-auto bg-white p-8 lg:p-16 rounded-[3rem] shadow-2xl border min-h-screen relative">
                    <button onClick={() => window.print()} className="no-print absolute top-8 right-8 bg-slate-900 text-white px-6 py-2 rounded-full font-black">ğŸ–¨ï¸ åˆ—å°è¬›ç¾©</button>
                    
                    <div className="border-b-8 border-slate-900 pb-8 mb-12">
                      <h1 className="text-4xl lg:text-5xl font-black mb-6 leading-tight">{handout.title}</h1>
                      <div className="flex flex-wrap gap-8 text-2xl font-bold pt-8 border-t-2">
                        <span>å§“åï¼š_______________</span>
                        <span>å¾—åˆ†ï¼š_______________</span>
                      </div>
                    </div>

                    <section className="mb-16">
                      <h2 className="text-3xl font-black bg-blue-100 text-blue-800 px-4 py-1 rounded-lg mb-8 inline-block">ğŸ’¡ é­”æ³•åŠ æ²¹ç«™</h2>
                      <p className="text-3xl leading-relaxed font-bold text-slate-800 mb-8">{handout.concept}</p>
                      {handout.visualAidSvg && (
                        <div className="p-10 bg-slate-50 rounded-3xl flex justify-center border-2 border-slate-100 overflow-x-auto" dangerouslySetInnerHTML={{ __html: handout.visualAidSvg }} />
                      )}
                    </section>

                    <section>
                      <h2 className="text-3xl font-black bg-emerald-100 text-emerald-800 px-4 py-1 rounded-lg mb-8 inline-block">âœï¸ é­”æ³•ç·´ç¿’é¡Œ</h2>
                      <div className="space-y-16">
                        {handout.examples.map((ex, i) => (
                          <div key={i} className="p-8 bg-slate-50 rounded-[2.5rem] border-2 border-slate-200">
                            <div className="flex justify-between items-start mb-6">
                              <p className="text-3xl font-bold text-slate-800 leading-relaxed">ä¾‹é¡Œ {i+1}ï¼š{ex.question}</p>
                              <button onClick={() => setVisibleCanvas(v => ({...v, [i]: !v[i]}))} className="no-print bg-white border-2 px-4 py-2 rounded-xl text-sm font-black shadow-sm">âœï¸ ç•«æ¿</button>
                            </div>
                            {visibleCanvas[i] && <DrawingCanvas id={i} isVisible={true} />}
                            <div className="mt-8 space-y-6">
                              {ex.stepByStep.map((s, si) => (
                                <div key={si} className="flex gap-4 items-center">
                                  <span className="w-10 h-10 bg-emerald-500 text-white rounded-full flex items-center justify-center font-black shrink-0 text-xl">{si+1}</span>
                                  <span className="text-2xl font-bold text-slate-600">{s}</span>
                                </div>
                              ))}
                              <div className="text-right text-4xl font-black text-emerald-600 pt-6">ç­”ï¼š{ex.answer}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </section>
                  </article>
                ) : (
                  <div className="h-full flex flex-col items-center justify-center opacity-20">
                    <span className="text-9xl mb-4">ğŸª„</span>
                    <p className="text-2xl font-black">é¸æ“‡å–®å…ƒï¼Œé–‹å§‹ç·¨ç¹”è¬›ç¾©</p>
                  </div>
                )}
              </main>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>